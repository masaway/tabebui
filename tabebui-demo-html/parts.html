<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éƒ¨ä½é¸æŠ - ãŸã¹ã¶ã„</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="header">
        <div class="header-content">
            <a href="index.html" class="logo">ğŸ¥© ãŸã¹ã¶ã„</a>
            <div class="user-info">
                <div class="level-badge" id="userLevel">Lv.1</div>
                <span id="userName">è‚‰å¥½ããƒ¦ãƒ¼ã‚¶ãƒ¼</span>
            </div>
        </div>
    </header>

    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <nav class="nav">
        <a href="index.html" class="nav-link">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
        <a href="parts.html" class="nav-link active">éƒ¨ä½ã‚’é¸ã¶</a>
        <a href="progress.html" class="nav-link">é€²æ—è©³ç´°</a>
        <a href="history.html" class="nav-link">å±¥æ­´</a>
    </nav>

    <div class="container">
        <!-- å‹•ç‰©é¸æŠ -->
        <div class="card" id="animalSelection">
            <h2>ğŸ„ğŸ·ğŸ” å‹•ç‰©ã‚’é¸æŠ</h2>
            <div class="animals-grid" id="animalsGrid">
                <!-- å‹•çš„ã«ç”Ÿæˆ -->
            </div>
        </div>

        <!-- éƒ¨ä½é¸æŠ -->
        <div class="card" id="partsSelection" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 id="animalTitle">éƒ¨ä½ã‚’é¸æŠ</h2>
                <button class="btn btn-outline" onclick="showAnimalSelection()">å‹•ç‰©é¸æŠã«æˆ»ã‚‹</button>
            </div>

            <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
            <div style="margin-bottom: 20px; text-align: center;">
                <button class="btn btn-outline filter-btn active" data-filter="all">ã™ã¹ã¦</button>
                <button class="btn btn-outline filter-btn" data-filter="eaten">é£Ÿã¹ãŸ</button>
                <button class="btn btn-outline filter-btn" data-filter="not-eaten">æœªé£Ÿ</button>
            </div>

            <!-- é€²æ—è¡¨ç¤º -->
            <div id="animalProgressContainer" class="progress-container" style="margin-bottom: 25px;">
                <!-- å‹•çš„ã«ç”Ÿæˆ -->
            </div>

            <!-- éƒ¨ä½ã‚°ãƒªãƒƒãƒ‰ -->
            <div class="parts-grid" id="partsGrid">
                <!-- å‹•çš„ã«ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <!-- éƒ¨ä½è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="partDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="partName">éƒ¨ä½è©³ç´°</h3>
                <button class="close-btn" onclick="closePartDetailModal()">&times;</button>
            </div>
            <div id="partDetailBody">
                <!-- å‹•çš„ã«ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <!-- è¨˜éŒ²ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="recordModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">éƒ¨ä½ã‚’è¨˜éŒ²</h3>
                <button class="close-btn" onclick="closeRecordModal()">&times;</button>
            </div>
            <div id="modalBody">
                <form id="recordForm">
                    <div class="form-group">
                        <label class="form-label">éƒ¨ä½</label>
                        <div id="selectedPartInfo" style="padding: 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px;">
                            <!-- é¸æŠã•ã‚ŒãŸéƒ¨ä½æƒ…å ± -->
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="eatenDate">é£Ÿã¹ãŸæ—¥</label>
                        <input type="date" id="eatenDate" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="memo">ãƒ¡ãƒ¢ãƒ»æ„Ÿæƒ³</label>
                        <textarea id="memo" class="form-control" placeholder="å‘³ã‚„é£Ÿæ„Ÿã€ãŠåº—ã®æƒ…å ±ãªã©..." rows="3"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">æº€è¶³åº¦</label>
                        <div id="ratingStars" style="text-align: center; padding: 10px;">
                            <span class="star" data-rating="1">â­</span>
                            <span class="star" data-rating="2">â­</span>
                            <span class="star" data-rating="3">â­</span>
                            <span class="star" data-rating="4">â­</span>
                            <span class="star" data-rating="5">â­</span>
                        </div>
                        <input type="hidden" id="ratingValue" value="5">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="restaurant">ãŠåº—ï¼ˆä»»æ„ï¼‰</label>
                        <input type="text" id="restaurant" class="form-control" placeholder="ãŠåº—ã®åå‰">
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 25px;">
                        <button type="submit" class="btn btn-success" style="flex: 1;">è¨˜éŒ²ã™ã‚‹</button>
                        <button type="button" class="btn btn-outline" onclick="closeRecordModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—é€šçŸ¥ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="levelUpModal">
        <div class="modal-content" style="text-align: center;">
            <div class="modal-header">
                <h3 class="modal-title">ğŸ‰ ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼</h3>
                <button class="close-btn" onclick="closeLevelUpModal()">&times;</button>
            </div>
            <div style="padding: 20px;">
                <div style="font-size: 3em; margin-bottom: 20px;">ğŸŠ</div>
                <div style="font-size: 1.5em; margin-bottom: 10px;">ãƒ¬ãƒ™ãƒ« <span id="newLevel">2</span> ã«ãªã‚Šã¾ã—ãŸï¼</div>
                <div style="color: #666; margin-bottom: 20px;">ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼</div>
                <button class="btn btn-primary" onclick="closeLevelUpModal()">ç¶šã‘ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- ãƒãƒƒã‚¸ç²å¾—é€šçŸ¥ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="badgeModal">
        <div class="modal-content" style="text-align: center;">
            <div class="modal-header">
                <h3 class="modal-title">ğŸ… ãƒãƒƒã‚¸ç²å¾—ï¼</h3>
                <button class="close-btn" onclick="closeBadgeModal()">&times;</button>
            </div>
            <div style="padding: 20px;">
                <div style="font-size: 3em; margin-bottom: 20px;">ğŸ–ï¸</div>
                <div style="font-size: 1.3em; margin-bottom: 10px;">ã€Œ<span id="badgeName">æ–°ã—ã„ãƒãƒƒã‚¸</span>ã€ã‚’ç²å¾—ã—ã¾ã—ãŸï¼</div>
                <div style="color: #666; margin-bottom: 20px;">ç´ æ™´ã‚‰ã—ã„ï¼</div>
                <button class="btn btn-primary" onclick="closeBadgeModal()">ç¶šã‘ã‚‹</button>
            </div>
        </div>
    </div>

    <script src="js/parts.js"></script>
    <script src="js/records.js"></script>
    <script src="js/main.js"></script>
    <script>
        let currentAnimal = null;
        let currentFilter = 'all';

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
            
            // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰å‹•ç‰©ã‚’å–å¾—
            const urlParams = new URLSearchParams(window.location.search);
            const animal = urlParams.get('animal');
            
            if (animal && ['beef', 'pork', 'chicken'].includes(animal)) {
                showPartsSelection(animal);
            } else {
                showAnimalSelection();
            }
            
            // ä»Šæ—¥ã®æ—¥ä»˜ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«è¨­å®š
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('eatenDate').value = today;
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
            setupEventListeners();
        });

        // ãƒšãƒ¼ã‚¸åˆæœŸåŒ–
        function initializePage() {
            const userLevel = getUserLevel();
            document.getElementById('userLevel').textContent = `Lv.${userLevel}`;
            
            generateAnimalsGrid();
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        function setupEventListeners() {
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentFilter = this.dataset.filter;
                    filterParts();
                });
            });

            // æ˜Ÿè©•ä¾¡
            setupRatingStars();
            
            // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
            document.getElementById('recordForm').addEventListener('submit', handleRecordSubmit);
        }

        // å‹•ç‰©é¸æŠã‚°ãƒªãƒƒãƒ‰ç”Ÿæˆ
        function generateAnimalsGrid() {
            const container = document.getElementById('animalsGrid');
            const animals = ['beef', 'pork', 'chicken'];
            
            container.innerHTML = '';
            
            animals.forEach(animalType => {
                const info = getAnimalInfo(animalType);
                const stats = getAnimalStats(animalType);
                
                const card = document.createElement('div');
                card.className = 'animal-card';
                card.onclick = () => showPartsSelection(animalType);
                
                card.innerHTML = `
                    <div class="animal-icon">${info.icon}</div>
                    <div class="animal-name">${info.name}</div>
                    <div class="animal-stats">
                        ${stats.eaten}/${stats.total} éƒ¨ä½
                        <div style="margin-top: 10px;">
                            <div class="progress-bar">
                                <div class="progress-fill progress-${animalType}" style="width: ${stats.completionRate}%"></div>
                            </div>
                            <small style="color: #666;">${stats.completionRate}% åˆ¶è¦‡</small>
                        </div>
                        <div style="margin-top: 8px; color: #666; font-size: 0.9em;">
                            æ®‹ã‚Š${stats.remaining}éƒ¨ä½
                        </div>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        // å‹•ç‰©é¸æŠç”»é¢è¡¨ç¤º
        function showAnimalSelection() {
            document.getElementById('animalSelection').style.display = 'block';
            document.getElementById('partsSelection').style.display = 'none';
            currentAnimal = null;
            
            // URLã‚’æ›´æ–°
            history.pushState({}, '', 'parts.html');
        }

        // éƒ¨ä½é¸æŠç”»é¢è¡¨ç¤º
        function showPartsSelection(animalType) {
            currentAnimal = animalType;
            const info = getAnimalInfo(animalType);
            const stats = getAnimalStats(animalType);
            
            // ã‚¿ã‚¤ãƒˆãƒ«æ›´æ–°
            document.getElementById('animalTitle').innerHTML = `${info.icon} ${info.name}ã®éƒ¨ä½ã‚’é¸æŠ`;
            
            // é€²æ—è¡¨ç¤ºæ›´æ–°
            const progressContainer = document.getElementById('animalProgressContainer');
            progressContainer.innerHTML = `
                <div class="progress-label">
                    <span>${info.name}ã®åˆ¶è¦‡ç‡</span>
                    <span>${stats.eaten}/${stats.total} (${stats.completionRate}%)</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill progress-${animalType}" style="width: ${stats.completionRate}%"></div>
                </div>
            `;
            
            // éƒ¨ä½ã‚°ãƒªãƒƒãƒ‰ç”Ÿæˆ
            generatePartsGrid(animalType);
            
            // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('animalSelection').style.display = 'none';
            document.getElementById('partsSelection').style.display = 'block';
            
            // URLã‚’æ›´æ–°
            history.pushState({}, '', `parts.html?animal=${animalType}`);
        }

        // éƒ¨ä½ã‚°ãƒªãƒƒãƒ‰ç”Ÿæˆ
        function generatePartsGrid(animalType) {
            const container = document.getElementById('partsGrid');
            const parts = getPartsByAnimal(animalType);
            const eatenParts = getEatenParts();
            
            container.innerHTML = '';
            
            parts.forEach(part => {
                const isEaten = eatenParts.includes(part.id);
                
                const card = document.createElement('div');
                card.className = `part-card ${isEaten ? 'eaten' : 'not-eaten'}`;
                card.dataset.partId = part.id;
                card.dataset.status = isEaten ? 'eaten' : 'not-eaten';
                
                card.innerHTML = `
                    <div class="part-name">${part.name}</div>
                    <div class="part-kana">${part.nameKana}</div>
                    <div class="rarity-stars">${getRarityStars(part.rarity)}</div>
                    ${isEaten ? '<div style="margin-top: 5px; font-size: 0.8em;">âœ… åˆ¶è¦‡æ¸ˆã¿</div>' : ''}
                `;
                
                // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
                card.addEventListener('click', () => {
                    showPartDetail(part);
                });
                
                container.appendChild(card);
            });
            
            // åˆæœŸãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
            filterParts();
        }

        // éƒ¨ä½ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        function filterParts() {
            const cards = document.querySelectorAll('.part-card');
            
            cards.forEach(card => {
                const status = card.dataset.status;
                
                switch (currentFilter) {
                    case 'eaten':
                        card.style.display = status === 'eaten' ? 'flex' : 'none';
                        break;
                    case 'not-eaten':
                        card.style.display = status === 'not-eaten' ? 'flex' : 'none';
                        break;
                    default:
                        card.style.display = 'flex';
                }
            });
        }

        // éƒ¨ä½è©³ç´°è¡¨ç¤º
        function showPartDetail(part) {
            const isEaten = isPartEaten(part.id);
            const rarityInfo = getRarityInfo(part.rarity);
            const animalInfo = getAnimalInfo(part.animalType);
            
            document.getElementById('partName').textContent = part.name;
            
            document.getElementById('partDetailBody').innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 3em; margin-bottom: 10px;">${animalInfo.icon}</div>
                    <div style="font-size: 1.2em; color: #666; margin-bottom: 5px;">${part.nameKana}</div>
                    <div style="color: ${rarityInfo.color}; font-weight: bold;">
                        ${getRarityStars(part.rarity)} ${rarityInfo.label}
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4>èª¬æ˜</h4>
                    <p style="color: #666; line-height: 1.6;">${part.description}</p>
                </div>
                
                ${isEaten ? 
                    `<div style="text-align: center; padding: 15px; background: #d4edda; border-radius: 8px; color: #155724; margin-bottom: 20px;">
                        âœ… ã“ã®éƒ¨ä½ã¯åˆ¶è¦‡æ¸ˆã¿ã§ã™ï¼
                    </div>` : ''
                }
                
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-success" style="flex: 1;" onclick="openRecordModal('${part.id}')">
                        ${isEaten ? 'å†åº¦è¨˜éŒ²ã™ã‚‹' : 'è¨˜éŒ²ã™ã‚‹'}
                    </button>
                    <button class="btn btn-outline" onclick="closePartDetailModal()">é–‰ã˜ã‚‹</button>
                </div>
            `;
            
            document.getElementById('partDetailModal').classList.add('active');
        }

        // è¨˜éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openRecordModal(partId) {
            const part = getPartById(partId);
            const animalInfo = getAnimalInfo(part.animalType);
            const rarityInfo = getRarityInfo(part.rarity);
            
            // é¸æŠã•ã‚ŒãŸéƒ¨ä½æƒ…å ±ã‚’è¡¨ç¤º
            document.getElementById('selectedPartInfo').innerHTML = `
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="font-size: 2em;">${animalInfo.icon}</div>
                    <div>
                        <div style="font-size: 1.2em; font-weight: bold;">${part.name}</div>
                        <div style="color: #666;">${part.nameKana}</div>
                        <div style="color: ${rarityInfo.color}; font-size: 0.9em;">
                            ${getRarityStars(part.rarity)} ${rarityInfo.label}
                        </div>
                    </div>
                </div>
            `;
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã«partIdã‚’è¨­å®š
            document.getElementById('recordForm').dataset.partId = partId;
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
            closePartDetailModal();
            document.getElementById('recordModal').classList.add('active');
        }

        // æ˜Ÿè©•ä¾¡è¨­å®š
        function setupRatingStars() {
            const stars = document.querySelectorAll('.star');
            const ratingInput = document.getElementById('ratingValue');
            
            stars.forEach((star, index) => {
                star.style.cursor = 'pointer';
                star.style.fontSize = '1.5em';
                star.style.margin = '0 2px';
                star.style.opacity = '1'; // åˆæœŸçŠ¶æ…‹ã¯å…¨ã¦ç‚¹ç¯
                
                star.addEventListener('click', () => {
                    const rating = parseInt(star.dataset.rating);
                    ratingInput.value = rating;
                    updateStarDisplay(rating);
                });
                
                star.addEventListener('mouseover', () => {
                    const rating = parseInt(star.dataset.rating);
                    updateStarDisplay(rating);
                });
            });
            
            // ãƒã‚¦ã‚¹ãŒé›¢ã‚ŒãŸã‚‰ç¾åœ¨ã®è©•ä¾¡ã«æˆ»ã™
            document.getElementById('ratingStars').addEventListener('mouseleave', () => {
                const currentRating = parseInt(ratingInput.value);
                updateStarDisplay(currentRating);
            });
        }

        // æ˜Ÿè¡¨ç¤ºæ›´æ–°
        function updateStarDisplay(rating) {
            const stars = document.querySelectorAll('.star');
            stars.forEach((star, index) => {
                star.style.opacity = index < rating ? '1' : '0.3';
            });
        }

        // ãƒ¬ã‚³ãƒ¼ãƒ‰é€ä¿¡å‡¦ç†
        function handleRecordSubmit(e) {
            e.preventDefault();
            
            const formData = {
                partId: this.dataset.partId,
                date: document.getElementById('eatenDate').value,
                memo: document.getElementById('memo').value,
                rating: parseInt(document.getElementById('ratingValue').value),
                restaurant: document.getElementById('restaurant').value
            };
            
            // è¨˜éŒ²ä¿å­˜
            const isNewRecord = addRecord(formData);
            
            if (isNewRecord) {
                // çµŒé¨“å€¤ã¨ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ãƒã‚§ãƒƒã‚¯
                const oldLevel = getUserLevel();
                updateUserExperience(10); // æ–°éƒ¨ä½ã§10XPç²å¾—
                const newLevel = getUserLevel();
                
                // ãƒãƒƒã‚¸ãƒã‚§ãƒƒã‚¯
                const newBadges = checkAndAwardBadges();
                
                // é€šçŸ¥è¡¨ç¤º
                if (newLevel > oldLevel) {
                    showLevelUpModal(newLevel);
                } else if (newBadges.length > 0) {
                    showBadgeModal(newBadges[0]);
                }
            }
            
            // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
            this.reset();
            document.getElementById('ratingValue').value = '5';
            updateStarDisplay(5);
            
            // ç”»é¢æ›´æ–°
            if (currentAnimal) {
                generatePartsGrid(currentAnimal);
                initializePage();
            }
            
            closeRecordModal();
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£
        function closePartDetailModal() {
            document.getElementById('partDetailModal').classList.remove('active');
        }

        function closeRecordModal() {
            document.getElementById('recordModal').classList.remove('active');
        }

        function closeLevelUpModal() {
            document.getElementById('levelUpModal').classList.remove('active');
        }

        function closeBadgeModal() {
            document.getElementById('badgeModal').classList.remove('active');
        }

        // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        function showLevelUpModal(level) {
            document.getElementById('newLevel').textContent = level;
            document.getElementById('levelUpModal').classList.add('active');
        }

        // ãƒãƒƒã‚¸ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        function showBadgeModal(badgeName) {
            document.getElementById('badgeName').textContent = badgeName;
            document.getElementById('badgeModal').classList.add('active');
        }
    </script>
</body>
</html>