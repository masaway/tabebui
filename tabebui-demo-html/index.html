<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãŸã¹ã¶ã„ - è‚‰éƒ¨ä½åˆ¶è¦‡ã‚¢ãƒ—ãƒª</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="header">
        <div class="header-content">
            <a href="index.html" class="logo">ğŸ¥© ãŸã¹ã¶ã„</a>
            <div class="user-info">
                <div class="level-badge" id="userLevel">Lv.1</div>
                <span id="userName">è‚‰å¥½ããƒ¦ãƒ¼ã‚¶ãƒ¼</span>
            </div>
        </div>
    </header>

    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <nav class="nav">
        <a href="index.html" class="nav-link active">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
        <a href="parts.html" class="nav-link">éƒ¨ä½ã‚’é¸ã¶</a>
        <a href="progress.html" class="nav-link">é€²æ—è©³ç´°</a>
        <a href="history.html" class="nav-link">å±¥æ­´</a>
    </nav>

    <div class="container">
        <!-- åˆ¶è¦‡ç‡ã‚µãƒãƒªãƒ¼ -->
        <div class="card">
            <h2>ğŸ† åˆ¶è¦‡çŠ¶æ³</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="circular-progress" id="overallProgress">
                        <svg>
                            <defs>
                                <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" style="stop-color:#667eea"/>
                                    <stop offset="100%" style="stop-color:#764ba2"/>
                                </linearGradient>
                            </defs>
                            <circle class="circle-bg" cx="100" cy="100" r="90"></circle>
                            <circle class="circle-progress" cx="100" cy="100" r="90"></circle>
                        </svg>
                        <div class="progress-text" id="overallPercentage">0%</div>
                    </div>
                    <div class="stat-label">å…¨ä½“åˆ¶è¦‡ç‡</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-value" id="totalEaten">0</div>
                    <div class="stat-label">é£Ÿã¹ãŸéƒ¨ä½æ•°</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-value" id="currentLevel">1</div>
                    <div class="stat-label">ç¾åœ¨ã®ãƒ¬ãƒ™ãƒ«</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-value" id="totalRecords">0</div>
                    <div class="stat-label">ç·è¨˜éŒ²æ•°</div>
                </div>
            </div>
        </div>

        <!-- å‹•ç‰©åˆ¥é€²æ— -->
        <div class="card">
            <h2>ğŸ„ğŸ·ğŸ” å‹•ç‰©åˆ¥åˆ¶è¦‡çŠ¶æ³</h2>
            <div id="animalProgress">
                <!-- å‹•çš„ã«ç”Ÿæˆ -->
            </div>
        </div>

        <!-- å‹•ç‰©é¸æŠ -->
        <div class="card">
            <h2>ğŸ“ éƒ¨ä½ã‚’è¨˜éŒ²ã™ã‚‹</h2>
            <div class="animals-grid" id="animalsGrid">
                <!-- å‹•çš„ã«ç”Ÿæˆ -->
            </div>
        </div>

        <!-- ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="card">
            <h2>âš¡ ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h2>
            <div style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center;">
                <a href="parts.html" class="btn btn-primary">éƒ¨ä½ã‚’é¸ã‚“ã§è¨˜éŒ²</a>
                <a href="progress.html" class="btn btn-outline">è©³ç´°ãªé€²æ—ã‚’è¦‹ã‚‹</a>
                <a href="history.html" class="btn btn-outline">é£Ÿäº‹å±¥æ­´ã‚’è¦‹ã‚‹</a>
            </div>
        </div>

        <!-- æœ€è¿‘ã®è¨˜éŒ² -->
        <div class="card">
            <h2>ğŸ“š æœ€è¿‘ã®è¨˜éŒ²</h2>
            <div id="recentRecords">
                <p style="text-align: center; color: #666; padding: 20px;">
                    ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>
                    <a href="parts.html" style="color: #764ba2;">éƒ¨ä½ã‚’é¸ã‚“ã§è¨˜éŒ²</a>ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼
                </p>
            </div>
        </div>

        <!-- ä»Šæ—¥ã®ãƒãƒ£ãƒ¬ãƒ³ã‚¸ -->
        <div class="card">
            <h2>ğŸ¯ ä»Šæ—¥ã®ãƒãƒ£ãƒ¬ãƒ³ã‚¸</h2>
            <div id="dailyChallenge">
                <div style="padding: 20px; text-align: center;">
                    <div style="font-size: 1.2em; margin-bottom: 10px;">æ–°ã—ã„éƒ¨ä½ã«æŒ‘æˆ¦ã—ã‚ˆã†ï¼</div>
                    <div style="color: #666;">ã¾ã é£Ÿã¹ãŸã“ã¨ã®ãªã„éƒ¨ä½ã‚’1ã¤è¨˜éŒ²ã—ã¦ã¿ã¾ã—ã‚‡ã†</div>
                    <div style="margin-top: 15px;">
                        <div class="progress-bar">
                            <div class="progress-fill progress-beef" style="width: 0%" id="challengeProgress"></div>
                        </div>
                        <div style="margin-top: 5px; font-size: 0.9em; color: #666;">
                            é€²æ—: <span id="challengeText">0/1</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ãƒãƒƒã‚¸è¡¨ç¤º -->
        <div class="card">
            <h2>ğŸ… ç²å¾—ãƒãƒƒã‚¸</h2>
            <div id="badgesContainer">
                <div style="text-align: center; padding: 20px; color: #666;">
                    éƒ¨ä½ã‚’è¨˜éŒ²ã—ã¦ãƒãƒƒã‚¸ã‚’ç²å¾—ã—ã‚ˆã†ï¼
                </div>
            </div>
        </div>
    </div>

    <!-- è¨˜éŒ²ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="recordModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">éƒ¨ä½ã‚’è¨˜éŒ²</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalBody">
                <form id="recordForm">
                    <div class="form-group">
                        <label class="form-label">éƒ¨ä½</label>
                        <div id="selectedPart" style="padding: 10px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px;">
                            <!-- é¸æŠã•ã‚ŒãŸéƒ¨ä½æƒ…å ± -->
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="eatenDate">é£Ÿã¹ãŸæ—¥</label>
                        <input type="date" id="eatenDate" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="memo">ãƒ¡ãƒ¢ãƒ»æ„Ÿæƒ³</label>
                        <textarea id="memo" class="form-control" placeholder="å‘³ã‚„é£Ÿæ„Ÿã€ãŠåº—ã®æƒ…å ±ãªã©..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="rating">æº€è¶³åº¦</label>
                        <div id="rating" style="text-align: center; padding: 10px;">
                            <span class="star" data-rating="1">â­</span>
                            <span class="star" data-rating="2">â­</span>
                            <span class="star" data-rating="3">â­</span>
                            <span class="star" data-rating="4">â­</span>
                            <span class="star" data-rating="5">â­</span>
                        </div>
                        <input type="hidden" id="ratingValue" value="5">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="restaurant">ãŠåº—ï¼ˆä»»æ„ï¼‰</label>
                        <input type="text" id="restaurant" class="form-control" placeholder="ãŠåº—ã®åå‰">
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 25px;">
                        <button type="submit" class="btn btn-success" style="flex: 1;">è¨˜éŒ²ã™ã‚‹</button>
                        <button type="button" class="btn btn-outline" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—é€šçŸ¥ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="levelUpModal">
        <div class="modal-content" style="text-align: center;">
            <div class="modal-header">
                <h3 class="modal-title">ğŸ‰ ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼</h3>
                <button class="close-btn" onclick="closeLevelUpModal()">&times;</button>
            </div>
            <div style="padding: 20px;">
                <div style="font-size: 3em; margin-bottom: 20px;">ğŸŠ</div>
                <div style="font-size: 1.5em; margin-bottom: 10px;">ãƒ¬ãƒ™ãƒ« <span id="newLevel">2</span> ã«ãªã‚Šã¾ã—ãŸï¼</div>
                <div style="color: #666; margin-bottom: 20px;">ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼</div>
                <button class="btn btn-primary" onclick="closeLevelUpModal()">ç¶šã‘ã‚‹</button>
            </div>
        </div>
    </div>

    <script src="js/parts.js"></script>
    <script src="js/records.js"></script>
    <script src="js/main.js"></script>
    <script>
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
            updateAllProgress();
            
            // ä»Šæ—¥ã®æ—¥ä»˜ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«è¨­å®š
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('eatenDate').value = today;
            
            // æ˜Ÿè©•ä¾¡ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            setupRatingStars();
        });

        // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰åˆæœŸåŒ–
        function initializeDashboard() {
            const stats = getOverallStats();
            const userLevel = getUserLevel();
            const userExp = getUserExperience();
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±æ›´æ–°
            document.getElementById('userLevel').textContent = `Lv.${userLevel}`;
            document.getElementById('currentLevel').textContent = userLevel;
            
            // çµ±è¨ˆæƒ…å ±æ›´æ–°
            document.getElementById('totalEaten').textContent = stats.eaten;
            document.getElementById('totalRecords').textContent = getRecords().length;
            
            // å‹•ç‰©ã‚°ãƒªãƒƒãƒ‰ç”Ÿæˆ
            generateAnimalsGrid();
            
            // å‹•ç‰©åˆ¥é€²æ—è¡¨ç¤º
            displayAnimalProgress();
            
            // æœ€è¿‘ã®è¨˜éŒ²è¡¨ç¤º
            displayRecentRecords();
            
            // ãƒãƒƒã‚¸è¡¨ç¤º
            displayBadges();
            
            // ãƒãƒ£ãƒ¬ãƒ³ã‚¸æ›´æ–°
            updateDailyChallenge();
        }

        // å‹•ç‰©é¸æŠã‚°ãƒªãƒƒãƒ‰ç”Ÿæˆ
        function generateAnimalsGrid() {
            const container = document.getElementById('animalsGrid');
            const animals = ['beef', 'pork', 'chicken'];
            
            container.innerHTML = '';
            
            animals.forEach(animalType => {
                const info = getAnimalInfo(animalType);
                const stats = getAnimalStats(animalType);
                
                const card = document.createElement('div');
                card.className = 'animal-card';
                card.onclick = () => window.location.href = `parts.html?animal=${animalType}`;
                
                card.innerHTML = `
                    <div class="animal-icon">${info.icon}</div>
                    <div class="animal-name">${info.name}</div>
                    <div class="animal-stats">
                        ${stats.eaten}/${stats.total} éƒ¨ä½
                        <div style="margin-top: 8px;">
                            <div class="progress-bar">
                                <div class="progress-fill progress-${animalType}" style="width: ${stats.completionRate}%"></div>
                            </div>
                            <small>${stats.completionRate}%</small>
                        </div>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        // å‹•ç‰©åˆ¥é€²æ—è¡¨ç¤º
        function displayAnimalProgress() {
            const container = document.getElementById('animalProgress');
            const animals = ['beef', 'pork', 'chicken'];
            
            container.innerHTML = '';
            
            animals.forEach(animalType => {
                const info = getAnimalInfo(animalType);
                const stats = getAnimalStats(animalType);
                
                const progressDiv = document.createElement('div');
                progressDiv.className = 'progress-container';
                progressDiv.innerHTML = `
                    <div class="progress-label">
                        <span>${info.icon} ${info.name}</span>
                        <span>${stats.eaten}/${stats.total} (${stats.completionRate}%)</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill progress-${animalType}" style="width: ${stats.completionRate}%"></div>
                    </div>
                `;
                
                container.appendChild(progressDiv);
            });
        }

        // å…¨ä½“é€²æ—æ›´æ–°
        function updateAllProgress() {
            const stats = getOverallStats();
            const percentage = stats.completionRate;
            
            // å††å½¢é€²æ—æ›´æ–°
            const circle = document.querySelector('.circle-progress');
            const text = document.getElementById('overallPercentage');
            
            if (circle && text) {
                const circumference = 2 * Math.PI * 90; // r=90
                const offset = circumference - (percentage / 100) * circumference;
                circle.style.strokeDashoffset = offset;
                text.textContent = `${percentage}%`;
            }
        }

        // æœ€è¿‘ã®è¨˜éŒ²è¡¨ç¤º
        function displayRecentRecords() {
            const container = document.getElementById('recentRecords');
            const records = getRecords().slice(-3).reverse(); // æœ€æ–°3ä»¶
            
            if (records.length === 0) {
                container.innerHTML = `
                    <p style="text-align: center; color: #666; padding: 20px;">
                        ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>
                        <a href="parts.html" style="color: #764ba2;">éƒ¨ä½ã‚’é¸ã‚“ã§è¨˜éŒ²</a>ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼
                    </p>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            records.forEach(record => {
                const part = getPartById(record.partId);
                if (!part) return;
                
                const recordDiv = document.createElement('div');
                recordDiv.style.cssText = 'padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;';
                
                recordDiv.innerHTML = `
                    <div>
                        <strong>${part.name}</strong> (${getAnimalInfo(part.animalType).name})
                        ${record.memo ? `<br><small style="color: #666;">${record.memo.substring(0, 50)}${record.memo.length > 50 ? '...' : ''}</small>` : ''}
                    </div>
                    <div style="text-align: right; color: #666; font-size: 0.9em;">
                        ${new Date(record.date).toLocaleDateString('ja-JP')}
                        ${record.rating ? '<br>' + 'â­'.repeat(record.rating) : ''}
                    </div>
                `;
                
                container.appendChild(recordDiv);
            });
        }

        // ãƒãƒƒã‚¸è¡¨ç¤º
        function displayBadges() {
            const container = document.getElementById('badgesContainer');
            const badges = getUserBadges();
            
            if (badges.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">éƒ¨ä½ã‚’è¨˜éŒ²ã—ã¦ãƒãƒƒã‚¸ã‚’ç²å¾—ã—ã‚ˆã†ï¼</div>';
                return;
            }
            
            container.innerHTML = '';
            
            badges.forEach(badge => {
                const badgeElement = document.createElement('span');
                badgeElement.className = 'badge earned';
                badgeElement.textContent = badge;
                badgeElement.title = badge;
                container.appendChild(badgeElement);
            });
        }

        // ãƒãƒ£ãƒ¬ãƒ³ã‚¸æ›´æ–°
        function updateDailyChallenge() {
            const records = getRecords();
            const today = new Date().toDateString();
            const todayRecords = records.filter(record => 
                new Date(record.date).toDateString() === today
            );
            
            const progress = Math.min(todayRecords.length, 1);
            const progressBar = document.getElementById('challengeProgress');
            const progressText = document.getElementById('challengeText');
            
            if (progressBar) {
                progressBar.style.width = `${progress * 100}%`;
            }
            
            if (progressText) {
                progressText.textContent = `${progress}/1`;
            }
        }

        // æ˜Ÿè©•ä¾¡è¨­å®š
        function setupRatingStars() {
            const stars = document.querySelectorAll('.star');
            const ratingInput = document.getElementById('ratingValue');
            
            stars.forEach((star, index) => {
                star.style.cursor = 'pointer';
                star.style.fontSize = '1.5em';
                star.style.margin = '0 2px';
                star.style.opacity = '0.3';
                
                star.addEventListener('click', () => {
                    const rating = parseInt(star.dataset.rating);
                    ratingInput.value = rating;
                    
                    // æ˜Ÿã®è¡¨ç¤ºæ›´æ–°
                    stars.forEach((s, i) => {
                        s.style.opacity = i < rating ? '1' : '0.3';
                    });
                });
                
                star.addEventListener('mouseover', () => {
                    const rating = parseInt(star.dataset.rating);
                    stars.forEach((s, i) => {
                        s.style.opacity = i < rating ? '1' : '0.3';
                    });
                });
            });
            
            // åˆæœŸçŠ¶æ…‹ï¼ˆ5ã¤æ˜Ÿï¼‰
            stars.forEach(star => star.style.opacity = '1');
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£
        function closeModal() {
            document.getElementById('recordModal').classList.remove('active');
        }

        function closeLevelUpModal() {
            document.getElementById('levelUpModal').classList.remove('active');
        }

        // ãƒ¬ã‚³ãƒ¼ãƒ‰é€ä¿¡
        document.getElementById('recordForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                partId: this.dataset.partId,
                date: document.getElementById('eatenDate').value,
                memo: document.getElementById('memo').value,
                rating: parseInt(document.getElementById('ratingValue').value),
                restaurant: document.getElementById('restaurant').value
            };
            
            // è¨˜éŒ²ä¿å­˜
            const isNewRecord = addRecord(formData);
            
            if (isNewRecord) {
                // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ãƒã‚§ãƒƒã‚¯
                const oldLevel = getUserLevel();
                updateUserExperience(10); // æ–°éƒ¨ä½ã§10XPç²å¾—
                const newLevel = getUserLevel();
                
                if (newLevel > oldLevel) {
                    // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—é€šçŸ¥
                    document.getElementById('newLevel').textContent = newLevel;
                    document.getElementById('levelUpModal').classList.add('active');
                }
                
                // ãƒãƒƒã‚¸ãƒã‚§ãƒƒã‚¯
                checkAndAwardBadges();
            }
            
            // ç”»é¢æ›´æ–°
            initializeDashboard();
            updateAllProgress();
            closeModal();
        });
    </script>
</body>
</html>